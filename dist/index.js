"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const TransformChildren=Symbol("transform children");function transformChildren(r,t){var n;return Array.isArray(r)?transformArray(r,t):"function"==typeof(null===(n=r)||void 0===n?void 0:n[TransformChildren])?r[TransformChildren](t):r}function transformArray(r,t){for(let n=0,e=r.length;n<e;++n){let a=r[n],s=t(a);if(a===s)continue;const i=r.slice(0,n);for(push(i,s),++n;n<e;++n)a=r[n],s=t(a),push(i,s);return i}return r}function push(r,t){if(null!=t)if(Array.isArray(t))for(const n of t)null!=n&&r.push(n);else r.push(t)}class Variable{constructor(r,t=null,n=null){this.name=r,this.fallbackType=t,this.fallback=n}toString(){var r,t;return"${"+this.name+(null!==(r=this.fallbackType)&&void 0!==r?r:"")+(null!==(t=this.fallback)&&void 0!==t?t:"")+"}"}[TransformChildren](r){const t=this.fallback;if(null==t)return t;const n=transformChildren(t,r);return n!==t?new Variable(this.name,this.fallbackType,n):this}}class VariableAssignment{constructor(r,t){this.name=r,this.value=t}toString(){return this.name+"="+this.value}withValue(r){return this.value===r?this:new VariableAssignment(this.name,r)}[TransformChildren](r){const t=this.value,n=transformChildren(t,r);return n!==t?new VariableAssignment(this.name,n):this}}class QuotedString{constructor(r){this.contents=r}toString(){return`"${this.contents}"`}[TransformChildren](r){const t=this.contents,n=transformChildren(t,r);return n!==t?new QuotedString(n):this}}class VerbatimString{constructor(r){this.contents=r}toString(){return`'${this.contents}'`}}class Word{constructor(r){this.contents=r}toString(){return""+this.contents}}class Whitespace{constructor(r){this.contents=r}toString(){return""+this.contents}}var tokens=Object.freeze({__proto__:null,Variable:Variable,VariableAssignment:VariableAssignment,QuotedString:QuotedString,VerbatimString:VerbatimString,Word:Word,Whitespace:Whitespace,TransformChildren:TransformChildren,transformChildren:transformChildren}),parser="use strict";function peg$subclass(r,t){function n(){this.constructor=r}n.prototype=t.prototype,r.prototype=new n}function peg$SyntaxError(r,t,n,e){this.message=r,this.expected=t,this.found=n,this.location=e,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,peg$SyntaxError)}function peg$parse(r,t){t=void 0!==t?t:{};var n,e={},a={start:K,VariableValue:function(){var r,t,n;r=O,t=[],(n=tr())===e&&(n=rr());for(;n!==e;)t.push(n),(n=tr())===e&&(n=rr());t!==e&&(Z=r,t=mr(t));return r=t}},s=K,i=D("=",!1),o=D("${",!1),u=D(":-",!1),c=D(":=",!1),l=D("}",!1),f=function(r){return new pr(r)},h=D("$",!1),p={type:"other",description:"variable name"},g=/^[a-zA-Z_]/,d=G([["a","z"],["A","Z"],"_"],!1,!1),A=/^[a-zA-Z_0-9]/,m=G([["a","z"],["A","Z"],"_",["0","9"]],!1,!1),v=/^[ \t\n\r]/,b=G([" ","\t","\n","\r"],!1,!1),y=/^[^ \t\n\r]/,x=G([" ","\t","\n","\r"],!0,!1),C=D("'",!1),S=D('"',!1),V=function(r){return new dr(r.join(""))},$=function(r){return r.join("")},W=D("\\",!1),w=/^[$"`\\]/,E=G(["$",'"',"`","\\"],!1,!1),T=D("\\\n",!1),_=/^[$"]/,k=G(["$",'"'],!1,!1),Q={type:"any"},F=/^[$}'"]/,j=G(["$","}","'",'"'],!1,!1),z=/^[$'"]/,R=G(["$","'",'"'],!1,!1),O=0,Z=0,M=[{line:1,column:1}],P=0,U=[],q=0;if("startRule"in t){if(!(t.startRule in a))throw new Error("Can't start parsing from rule \""+t.startRule+'".');s=a[t.startRule]}function B(){return r.substring(Z,O)}function D(r,t){return{type:"literal",text:r,ignoreCase:t}}function G(r,t,n){return{type:"class",parts:r,inverted:t,ignoreCase:n}}function H(t){var n,e=M[t];if(e)return e;for(n=t-1;!M[n];)n--;for(e={line:(e=M[n]).line,column:e.column};n<t;)10===r.charCodeAt(n)?(e.line++,e.column=1):e.column++,n++;return M[t]=e,e}function I(r,t){var n=H(r),e=H(t);return{start:{offset:r,line:n.line,column:n.column},end:{offset:t,line:e.line,column:e.column}}}function J(r){O<P||(O>P&&(P=O,U=[]),U.push(r))}function K(){var r,t;for(r=[],(t=N())===e&&(t=L())===e&&(t=rr());t!==e;)r.push(t),(t=N())===e&&(t=L())===e&&(t=rr());return r}function L(){var r;return(r=nr())===e&&(r=er())===e&&(r=function(){var r,t,n;if(r=O,t=[],(n=cr())!==e)for(;n!==e;)t.push(n),n=cr();else t=e;t!==e&&(Z=r,t=V(t));return r=t}())===e&&(r=X()),r}function N(){var t,n,a,s,o;if(t=O,(n=Y())!==e)if(61===r.charCodeAt(O)?(a="=",O++):(a=e,0===q&&J(i)),a!==e){if(s=[],(o=L())!==e)for(;o!==e;)s.push(o),o=L();else s=e;s!==e?(Z=t,t=n=new gr(n,mr(s))):(O=t,t=e)}else O=t,t=e;else O=t,t=e;return t}function X(){var t,n,a,s,i,p;return t=O,"${"===r.substr(O,2)?(n="${",O+=2):(n=e,0===q&&J(o)),n!==e&&(a=Y())!==e?(":-"===r.substr(O,2)?(s=":-",O+=2):(s=e,0===q&&J(u)),s===e&&(":="===r.substr(O,2)?(s=":=",O+=2):(s=e,0===q&&J(c))),s!==e&&(i=function(){var r,t,n;r=O,t=[],(n=nr())===e&&(n=er())===e&&(n=ar())===e&&(n=X())===e&&(n=rr());for(;n!==e;)t.push(n),(n=nr())===e&&(n=er())===e&&(n=ar())===e&&(n=X())===e&&(n=rr());t!==e&&(Z=r,t=function(r){return mr(r)}(t));return r=t}())!==e?(125===r.charCodeAt(O)?(p="}",O++):(p=e,0===q&&J(l)),p!==e?(Z=t,t=n=new pr(a,s,i)):(O=t,t=e)):(O=t,t=e)):(O=t,t=e),t===e&&(t=O,"${"===r.substr(O,2)?(n="${",O+=2):(n=e,0===q&&J(o)),n!==e&&(a=Y())!==e?(125===r.charCodeAt(O)?(s="}",O++):(s=e,0===q&&J(l)),s!==e?(Z=t,t=n=f(a)):(O=t,t=e)):(O=t,t=e),t===e&&(t=O,36===r.charCodeAt(O)?(n="$",O++):(n=e,0===q&&J(h)),n!==e&&(a=Y())!==e?(Z=t,t=n=f(a)):(O=t,t=e),t===e&&(t=O,36===r.charCodeAt(O)?(n="$",O++):(n=e,0===q&&J(h)),n!==e&&(Z=t,n=new hr("$")),t=n))),t}function Y(){var t,n,a,s;if(q++,t=O,g.test(r.charAt(O))?(n=r.charAt(O),O++):(n=e,0===q&&J(d)),n!==e){for(a=[],A.test(r.charAt(O))?(s=r.charAt(O),O++):(s=e,0===q&&J(m));s!==e;)a.push(s),A.test(r.charAt(O))?(s=r.charAt(O),O++):(s=e,0===q&&J(m));a!==e?(Z=t,t=n=B()):(O=t,t=e)}else O=t,t=e;return q--,t===e&&(n=e,0===q&&J(p)),t}function rr(){var t,n,a;if(t=O,n=[],v.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(b)),a!==e)for(;a!==e;)n.push(a),v.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(b));else n=e;return n!==e&&(Z=t,n=new Ar(B())),t=n}function tr(){var t,n,a;if(t=O,n=[],y.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(x)),a!==e)for(;a!==e;)n.push(a),y.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(x));else n=e;return n!==e&&(Z=t,n=new dr(B())),t=n}function nr(){var t,n,a,s;return t=O,39===r.charCodeAt(O)?(n="'",O++):(n=e,0===q&&J(C)),n!==e&&(a=function(){var r,t,n;if(r=O,t=[],(n=or())!==e)for(;n!==e;)t.push(n),n=or();else t=e;t!==e&&(Z=r,t=$(t));return r=t}())!==e?(39===r.charCodeAt(O)?(s="'",O++):(s=e,0===q&&J(C)),s!==e?(Z=t,t=n=new hr(a)):(O=t,t=e)):(O=t,t=e),t}function er(){var t,n,a,s;if(t=O,34===r.charCodeAt(O)?(n='"',O++):(n=e,0===q&&J(S)),n!==e){for(a=[],(s=sr())===e&&(s=X());s!==e;)a.push(s),(s=sr())===e&&(s=X());a!==e?(34===r.charCodeAt(O)?(s='"',O++):(s=e,0===q&&J(S)),s!==e?(Z=t,t=n=function(r){return new fr(r)}(a)):(O=t,t=e)):(O=t,t=e)}else O=t,t=e;return t}function ar(){var r,t,n;if(r=O,t=[],(n=ur())!==e)for(;n!==e;)t.push(n),n=ur();else t=e;return t!==e&&(Z=r,t=V(t)),r=t}function sr(){var r,t,n;if(r=O,t=[],(n=ir())!==e)for(;n!==e;)t.push(n),n=ir();else t=e;return t!==e&&(Z=r,t=$(t)),r=t}function ir(){var t,n,a;return t=O,92===r.charCodeAt(O)?(n="\\",O++):(n=e,0===q&&J(W)),n!==e?(w.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(E)),a!==e?(Z=t,t=n=a):(O=t,t=e)):(O=t,t=e),t===e&&(t=O,"\\\n"===r.substr(O,2)?(n="\\\n",O+=2):(n=e,0===q&&J(T)),n!==e&&(Z=t,n=""),(t=n)===e&&(t=O,n=O,q++,_.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(k)),q--,a===e?n=void 0:(O=n,n=e),n!==e?(r.length>O?(a=r.charAt(O),O++):(a=e,0===q&&J(Q)),a!==e?(Z=t,t=n=a):(O=t,t=e)):(O=t,t=e))),t}function or(){var t,n,a;return t=O,n=O,q++,39===r.charCodeAt(O)?(a="'",O++):(a=e,0===q&&J(C)),q--,a===e?n=void 0:(O=n,n=e),n!==e?(r.length>O?(a=r.charAt(O),O++):(a=e,0===q&&J(Q)),a!==e?(Z=t,t=n=a):(O=t,t=e)):(O=t,t=e),t}function ur(){var t,n,a;return(t=lr())===e&&(t=O,n=O,q++,F.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(j)),a===e&&(a=rr()),q--,a===e?n=void 0:(O=n,n=e),n!==e?(r.length>O?(a=r.charAt(O),O++):(a=e,0===q&&J(Q)),a!==e?(Z=t,t=n=a):(O=t,t=e)):(O=t,t=e)),t}function cr(){var t,n,a;return(t=lr())===e&&(t=O,n=O,q++,z.test(r.charAt(O))?(a=r.charAt(O),O++):(a=e,0===q&&J(R)),a===e&&(a=rr()),q--,a===e?n=void 0:(O=n,n=e),n!==e?(r.length>O?(a=r.charAt(O),O++):(a=e,0===q&&J(Q)),a!==e?(Z=t,t=n=a):(O=t,t=e)):(O=t,t=e)),t}function lr(){var t,n,a;return t=O,"\\\n"===r.substr(O,2)?(n="\\\n",O+=2):(n=e,0===q&&J(T)),n!==e&&(Z=t,n=""),(t=n)===e&&(t=O,92===r.charCodeAt(O)?(n="\\",O++):(n=e,0===q&&J(W)),n!==e?(r.length>O?(a=r.charAt(O),O++):(a=e,0===q&&J(Q)),a!==e?(Z=t,t=n=a):(O=t,t=e)):(O=t,t=e)),t}const{QuotedString:fr,VerbatimString:hr,Variable:pr,VariableAssignment:gr,Word:dr,Whitespace:Ar}=tokens;function mr(r){return 1===r.length?r[0]:r}if((n=s())!==e&&O===r.length)return n;throw n!==e&&O<r.length&&J({type:"end"}),vr=U,br=P<r.length?r.charAt(P):null,yr=P<r.length?I(P,P+1):I(P,P),new peg$SyntaxError(peg$SyntaxError.buildMessage(vr,br),vr,br,yr);var vr,br,yr}peg$subclass(peg$SyntaxError,Error),peg$SyntaxError.buildMessage=function(r,t){var n={literal:function(r){return'"'+a(r.text)+'"'},class:function(r){var t,n="";for(t=0;t<r.parts.length;t++)n+=r.parts[t]instanceof Array?s(r.parts[t][0])+"-"+s(r.parts[t][1]):s(r.parts[t]);return"["+(r.inverted?"^":"")+n+"]"},any:function(r){return"any character"},end:function(r){return"end of input"},other:function(r){return r.description}};function e(r){return r.charCodeAt(0).toString(16).toUpperCase()}function a(r){return r.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(r){return"\\x0"+e(r)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(r){return"\\x"+e(r)}))}function s(r){return r.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(r){return"\\x0"+e(r)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(r){return"\\x"+e(r)}))}return"Expected "+function(r){var t,e,a,s=new Array(r.length);for(t=0;t<r.length;t++)s[t]=(a=r[t],n[a.type](a));if(s.sort(),s.length>0){for(t=1,e=1;t<s.length;t++)s[t-1]!==s[t]&&(s[e]=s[t],e++);s.length=e}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(r)+" but "+function(r){return r?'"'+a(r)+'"':"end of input"}(t)+" found."};var parser_1=(parser={SyntaxError:peg$SyntaxError,parse:peg$parse}).parse;function collapseWhitespace(r){if(null==r)return null;if(!Array.isArray(r))return r instanceof Whitespace?null:r;let t=!1,n=!1;return transformChildren(r,r=>{if(r instanceof Whitespace)return t=!0,null;const e=t&&n;return t=!1,n=!0,e?[new Whitespace(" "),r]:r})}function stringify(r){var t;return null!==(t=str(r))&&void 0!==t?t:""}function str(r){var t,n;if("string"==typeof r)return r;if(Array.isArray(r))return transformChildren(r,str).join("");if(r instanceof VariableAssignment)return`${r.name}=${null!==(t=str(r.value))&&void 0!==t?t:""}`;if(r instanceof QuotedString){const t=null!==(n=r.contents)&&void 0!==n?n:"";if("string"==typeof t)return t;let e="";return transformChildren(t,r=>{var t;return e+=null!==(t=str(r))&&void 0!==t?t:"",r}),e}return r instanceof Word||r instanceof VerbatimString||r instanceof Whitespace?r.contents:void 0}const parseOptions={startRule:"VariableValue"},parseEnvValue=r=>parser_1(r,parseOptions);function substitute(r,t,n=!1){return function r(e){if(e instanceof Variable){const n=t[e.name];return null==n||""===n?e.fallback?r(e.fallback):null:parseEnvValue(n)}if(e instanceof VariableAssignment){const a=r(e.value);if(null==a)return null;if(n){const r=collapseWhitespace(a);if(null==r)return null;const n=stringify(r);return t[e.name]=n,null}return e.withValue(a)}return transformChildren(e,r)}(r)}function toShellArgs(r){if(Array.isArray(r)){const t=[];let n=!1;for(const e of r)if(e instanceof Whitespace)n=!0;else{const r=toShellArgs(e);null!==r&&(n||0===t.length?t.push(r):t[t.length-1]+=r,n=!1)}return t}return r instanceof Variable||r instanceof VariableAssignment?null:r instanceof QuotedString?stringify(r):r instanceof Word||r instanceof VerbatimString||r instanceof Whitespace?r.contents:void 0}function extractEnvironment(r,t={}){return null!=r&&function r(n){if(n instanceof VariableAssignment){const r=substitute(n.value,t,!1),e=stringify(collapseWhitespace(r));""!==e&&(t[n.name]=e)}else transformChildren(n,r);return n}(r),t}const parse=r=>parser_1(r),replace=(r,t)=>stringify(collapseWhitespace(substitute(parser_1(r),t)));exports.QuotedString=QuotedString,exports.TransformChildren=TransformChildren,exports.Variable=Variable,exports.VariableAssignment=VariableAssignment,exports.VerbatimString=VerbatimString,exports.Whitespace=Whitespace,exports.Word=Word,exports.collapseWhitespace=collapseWhitespace,exports.extractEnvironment=extractEnvironment,exports.parse=parse,exports.replace=replace,exports.stringify=stringify,exports.substitute=substitute,exports.toShellArgs=toShellArgs,exports.transformChildren=transformChildren;
//# sourceMappingURL=index.js.map
